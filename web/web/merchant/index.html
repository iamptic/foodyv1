<!doctype html><html lang="ru"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Foody ‚Äî –õ–ö</title><script src="/config.js"></script>
<style>
:root{--bg:#0b0c10;--card:#12141a;--mut:#8b90a2;--pri:#7bd88f;--err:#ff6b6b;--br:#22252f}
*{box-sizing:border-box}body{margin:0;background:linear-gradient(180deg,#0b0c10,#10131a 60%);color:#eef1f5;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
.wrap{max-width:1100px;margin:0 auto;padding:16px 16px 60px}.grid{display:grid;gap:12px}.g2{grid-template-columns:1fr 1fr}.g3{grid-template-columns:1fr 1fr 1fr}
.card{background:#12141a;border:1px solid #22252f;border-radius:16px;padding:14px}.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
label{display:block;margin:6px 0 6px 2px;color:#cbd1de;font-size:12px}input,textarea{width:100%;padding:12px;border:1px solid #22252f;border-radius:12px;background:#0e1117;color:#eef1f5;outline:none}
.btn{padding:10px 12px;border-radius:12px;border:1px solid #22252f;background:#131723;color:#eef1f5;cursor:pointer}.btn.primary{background:#7bd88f;color:#08120b;border-color:#57c874}
.tbl{width:100%;border-collapse:collapse}.tbl th,.tbl td{border-bottom:1px solid #232838;padding:10px 8px}.tbl th{color:#9aa1b3;font-weight:600;text-transform:uppercase;font-size:12px}
.toast{position:fixed;right:12px;bottom:12px;background:#090c12;border:1px solid #2b3042;color:#eef1f5;padding:10px 12px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
.pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #2a3040;background:#111522;color:#cdd3e2;font-size:12px}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);padding:16px}.dialog{max-width:520px;width:100%;background:#0e1117;border:1px solid #2a2f45;border-radius:16px;padding:16px}
.badge-arch{background:#221522;color:#f0b;border:1px solid #3a2348}
</style></head>
<body><div class="wrap"><h1>üçΩ Foody ‚Äî –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
<div class="grid g2">
<div class="card"><h3>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</h3><div class="grid g2">
<div><label>–ê–¥—Ä–µ—Å API</label><input id="api" placeholder="https://backend-....up.railway.app"><div class="mut" style="margin-top:6px">–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.</div></div>
<div class="row" style="align-items:end"><button class="btn" id="btnSaveApi">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å API</button><button class="btn" id="btnProbe">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button><button class="btn" id="btnClear">–°–±—Ä–æ—Å–∏—Ç—å –õ–ö</button></div></div>
<pre id="log" class="mut" style="max-height:140px;overflow:auto;background:#0c1018;border:1px dashed #2b3042;padding:8px;border-radius:12px;margin-top:8px"></pre></div>

<div class="card" id="cardLogin"><h3>–í—Ö–æ–¥</h3><div class="grid g2">
<div><label>RID</label><input id="login_rid"></div><div><label>API Key</label><input id="login_key"></div></div>
<div class="row" style="margin-top:8px"><button class="btn" id="btnLogin">–í–æ–π—Ç–∏</button></div></div>

<div class="card" id="cardRegister"><h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
<div class="grid g2"><div><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="name" placeholder="–ü–µ–∫–∞—Ä–Ω—è ‚Ññ1"></div><div><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="phone" placeholder="+7..."></div></div>
<div class="grid g3"><div><label>–ì–æ—Ä–æ–¥</label><input id="city" placeholder="–ú–æ—Å–∫–≤–∞"></div><div><label>–ê–¥—Ä–µ—Å</label><input id="addr" placeholder="—É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, 1"></div><div><label>–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è</label><div class="row"><button class="btn" id="btnGeo">–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å</button><span class="mut" id="geoLbl" class="mut">–Ω–µ—Ç</span></div></div></div>
<div class="row" style="margin-top:8px"><button class="btn primary" id="btnRegister">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><span class="mut">RID –∏ –∫–ª—é—á —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ</span></div></div>

<div class="card" id="cardOffer" style="display:none"><h3>–ù–æ–≤—ã–π –æ—Ñ—Ñ–µ—Ä</h3>
<div class="grid g2"><div><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="title"></div><div><label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label><input id="qty" value="5"></div></div>
<label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="descr"></textarea>
<div class="grid g3"><div><label>–¶–µ–Ω–∞, ‚ÇΩ</label><input id="price" placeholder="199,00"></div><div><label>–û–±—ã—á–Ω–∞—è —Ü–µ–Ω–∞, ‚ÇΩ</label><input id="original_price" placeholder="349,00"></div><div><label>–î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –¥–æ</label><input id="expires" type="datetime-local"></div></div>
<div class="row" style="margin-top:6px"><span class="pill">–ë—ã—Å—Ç—Ä—ã–µ</span><button class="btn" id="btnPreset30">‚àí30%</button><button class="btn" id="btnPreset50">‚àí50%</button><button class="btn" id="btnPreset70">‚àí70%</button><span class="pill">–í—Ä–µ–º—è</span><button class="btn" id="btnPlus1h">+1 —á–∞—Å</button><button class="btn" id="btnPlus2h">+2 —á–∞—Å–∞</button></div>
<div class="row" style="margin-top:10px"><button class="btn primary" id="btnCreateOffer">–°–æ–∑–¥–∞—Ç—å –æ—Ñ—Ñ–µ—Ä</button></div></div>

<div class="card" id="cardGrid" style="display:none"><h3>–ú–æ–∏ –æ—Ñ—Ñ–µ—Ä—ã</h3>
<table class="tbl" id="offersTbl"><thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–¶–µ–Ω–∞</th><th>–î–æ</th><th>–û—Å—Ç.</th><th></th></tr></thead><tbody id="tbody"></tbody></table>
<div class="row" style="margin-top:8px"><button class="btn" id="btnExport">–≠–∫—Å–ø–æ—Ä—Ç CSV</button></div></div>

<div class="card" id="cardProfile" style="display:none"><h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>
<label>RID</label><input id="rid" readonly><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="prof_title"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="prof_phone"><label>–ì–æ—Ä–æ–¥</label><input id="prof_city"><label>–ê–¥—Ä–µ—Å</label><input id="prof_addr">
<div class="row" style="margin-top:8px"><button class="btn primary" id="btnSaveProfile">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button></div></div>

<div class="card"><h3>–ö–∞—Å—Å–∞: –ø–æ–≥–∞—à–µ–Ω–∏–µ –±—Ä–æ–Ω–∏</h3><div class="row"><div><input id="redeemCode" placeholder="–í–≤–µ—Å—Ç–∏ –∫–æ–¥"></div><div><button class="btn primary" id="btnRedeem">–ü–æ–≥–∞—Å–∏—Ç—å</button></div></div></div>
<div class="card" id="kpiCard" style="display:none"><h3>KPI</h3><div id="kpiBox" class="mut">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>

</div></div>

<div class="modal" id="editModal"><div class="dialog"><h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ñ—Ñ–µ—Ä</h3>
<label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="edit_title"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="edit_descr"></textarea>
<div class="grid g3"><div><label>–¶–µ–Ω–∞, ‚ÇΩ</label><input id="edit_price"></div><div><label>–û–±—ã—á–Ω–∞—è —Ü–µ–Ω–∞, ‚ÇΩ</label><input id="edit_original"></div><div><label>–î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –¥–æ</label><input id="edit_expires" type="datetime-local"></div></div>
<div class="row" style="margin-top:10px"><button class="btn primary" id="btnEditSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button class="btn" id="btnEditCancel">–û—Ç–º–µ–Ω–∞</button></div></div></div>

<script>
(function(){
  const $=id=>document.getElementById(id);
  const pad=n=>String(n).padStart(2,'0'); const fmtLocal=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  const rub=n=>(n/100).toFixed(2).replace('.',','); const log=t=>{const el=$('log'); el.textContent=(t||'')+"\n"+el.textContent;};
  const toast=t=>{const d=document.createElement('div'); d.className='toast'; d.textContent=t; document.body.appendChild(d); setTimeout(()=>d.remove(),2500);};
  const numCents=inp=>Math.round(parseFloat((inp.value||'0').replace(',','.'))*100)||0;
  function resolveApi(){const c=(window.foodyApi||'').trim(); const ls=(localStorage.getItem('foody_api')||'').trim(); const fb=location.origin.replace(/\/web$/,''); return c||ls||fb;}
  function API(){return resolveApi()} function setApi(v){localStorage.setItem('foody_api',(v||'').trim()); $('api').value=(v||'').trim();}
  const RID=()=>{try{return (JSON.parse(localStorage.getItem('foody_restaurant')||'{}').id)||''}catch(_){return ''}}; const KEY=()=>localStorage.getItem('foody_key')||'';
  let OFFERS_CACHE=[]; function localArchKey(){return 'foody_arch_local_'+RID()} function localArchived(){try{return new Set(JSON.parse(localStorage.getItem(localArchKey())||'[]'))}catch(_){return new Set()}} function saveLocalArchived(s){localStorage.setItem(localArchKey(),JSON.stringify([...s]))}
  async function discoverAPI(){try{const r=await fetch(API()+'/openapi.json',{cache:'no-store'}); if(!r.ok) return {}; const j=await r.json(); return j.paths||{} }catch(_){return {}}}

  document.addEventListener('DOMContentLoaded',()=>{
    $('api').value=resolveApi();
    $('btnSaveApi').onclick=()=>{setApi($('api').value); toast('API —Å–æ—Ö—Ä–∞–Ω—ë–Ω')};
    $('btnProbe').onclick=async()=>{try{const r=await fetch(API()+'/health',{cache:'no-store'}); log('GET /health ‚Üí '+r.status+' '+(r.ok?'OK':'ERR'));}catch(e){log('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: '+e)}};
    $('btnClear').onclick=()=>{localStorage.removeItem('foody_restaurant'); localStorage.removeItem('foody_key'); location.reload()};
    $('btnLogin').onclick=loginWithKey; $('btnRegister').onclick=registerRestaurant; $('btnSaveProfile').onclick=saveProfile; $('btnCreateOffer').onclick=createOffer; $('btnExport').onclick=exportCSV; $('btnRedeem').onclick=redeem;
    $('btnPreset30').onclick=()=>{const p=numCents($('original_price')); if(p>0) $('price').value=(p*0.7/100).toFixed(2).replace('.',',')}; $('btnPreset50').onclick=()=>{const p=numCents($('original_price')); if(p>0) $('price').value=(p*0.5/100).toFixed(2).replace('.',',')}; $('btnPreset70').onclick=()=>{const p=numCents($('original_price')); if(p>0) $('price').value=(p*0.3/100).toFixed(2).replace('.',',')};
    $('btnPlus1h').onclick=()=>{const d=$('expires').value?new Date($('expires').value):new Date(); d.setHours(d.getHours()+1); $('expires').value=fmtLocal(d)}; $('btnPlus2h').onclick=()=>{const d=$('expires').value?new Date($('expires').value):new Date(); d.setHours(d.getHours()+2); $('expires').value=fmtLocal(d)};
    if(navigator.geolocation){ $('btnGeo').onclick=()=>navigator.geolocation.getCurrentPosition(p=>{const {latitude,longitude}=p.coords||{}; $('geoLbl').textContent=latitude&&longitude?(latitude.toFixed(5)+', '+longitude.toFixed(5)):'–Ω–µ—Ç'; const rec=JSON.parse(localStorage.getItem('foody_restaurant')||'{}'); rec.lat=latitude; rec.lng=longitude; localStorage.setItem('foody_restaurant',JSON.stringify(rec));},()=>toast('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é')) } 
    const d=new Date(); d.setHours(d.getHours()+2); $('expires').value=fmtLocal(d);
    if(RID()) enterLK();
  });

  function enterLK(){ $('cardLogin').style.display='none'; $('cardRegister').style.display='none'; $('cardOffer').style.display='block'; $('cardGrid').style.display='block'; $('cardProfile').style.display='block'; $('rid').value=RID(); loadProfile(); loadOffers(); loadKPI(); }

  async function loginWithKey(){
    const rid=($('login_rid').value||'').trim(); const key=($('login_key').value||'').trim();
    if(!rid||!key){ toast('–£–∫–∞–∂–∏ RID –∏ API Key'); return }
    try{ const r=await fetch(API()+`/api/v1/merchant/profile?restaurant_id=${encodeURIComponent(rid)}`,{headers:{'X-Foody-Key':key}});
      if(!r.ok){ const t=await r.text().catch(()=> ''); log('login: '+r.status+' '+t); toast('–ù–µ–≤–µ—Ä–Ω—ã–µ RID/Key'); return }
      const p=await r.json(); localStorage.setItem('foody_restaurant', JSON.stringify({id:rid, title:p.title, phone:p.phone})); localStorage.setItem('foody_key', key); toast('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω'); enterLK();
    }catch(e){ log('login js: '+e); toast('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞') }
  }

  async function registerRestaurant(){
    const name=($('name').value||'').trim(); const phone=($('phone').value||'').trim(); const city=($('city').value||'').trim(); const addr=($('addr').value||'').trim();
    if(!name){ toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'); return }
    for(let i=0;i<2;i++){ try{ await fetch(API()+'/health',{cache:'no-store'}) }catch(_){} }
    try{
      let r=await fetch(API()+'/api/v1/merchant/register_public',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title:name, phone})});
      if(!r.ok){ const t=await r.text().catch(()=> ''); if(r.status===415||r.status===422||r.status===400){ r=await fetch(API()+'/api/v1/merchant/register_public',{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({title:name, phone})}); } }
      if(!r.ok){ const t=await r.text().catch(()=> ''); log('register_public: '+r.status+' '+t); toast('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏'); return }
      const data=await r.json(); const rec={id:data.restaurant_id, title:name, phone, city, addr}; localStorage.setItem('foody_restaurant',JSON.stringify(rec)); localStorage.setItem('foody_key',data.api_key); enterLK(); toast('–ì–æ—Ç–æ–≤–æ!');
    }catch(e){ log('JS: '+e); toast('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞') }
  }

  async function loadProfile(){
    try{
      const r=await fetch(API()+`/api/v1/merchant/profile?restaurant_id=${RID()}`,{headers:{'X-Foody-Key':KEY()}});
      if(r.ok){ const p=await r.json(); $('prof_title').value=p.title||''; $('prof_phone').value=p.phone||''; }
      const loc=JSON.parse(localStorage.getItem('foody_restaurant')||'{}'); $('prof_city').value=loc.city||''; $('prof_addr').value=loc.addr||'';
    }catch(_){}
  }

  async function saveProfile(){
    const body={restaurant_id:RID(), title:$('prof_title').value||'', phone:$('prof_phone').value||''};
    const r=await fetch(API()+'/api/v1/merchant/profile',{method:'POST',headers:{'Content-Type':'application/json','X-Foody-Key':KEY()}, body:JSON.stringify(body)});
    const loc=JSON.parse(localStorage.getItem('foody_restaurant')||'{}'); loc.city=$('prof_city').value||''; loc.addr=$('prof_addr').value||''; localStorage.setItem('foody_restaurant',JSON.stringify(loc));
    if(r.ok){ toast('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω') } else { const t=await r.text().catch(()=> ''); log('profile: '+r.status+' '+t); toast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è') }
  }

  async function loadOffers(){
    try{
      const r=await fetch(API()+`/api/v1/merchant/offers?restaurant_id=${RID()}&status=active`,{headers:{'X-Foody-Key':KEY()}});
      const arr=r.ok?await r.json():[]; OFFERS_CACHE=arr; const arch=localArchived();
      const tbody=$('tbody'); tbody.innerHTML=arr.map(x=>{const price=(x.original_price_cents?`<span class="price"><s>${rub(x.original_price_cents)} ‚ÇΩ</s> ‚Üí </span>`:'')+`<b>${rub(x.price_cents)} ‚ÇΩ</b>`; const until=new Date(x.expires_at).toLocaleString(); const left=`${x.qty_left}/${x.qty_total}`; const local=arch.has(x.id);
        return `<tr data-id="${x.id}"><td>${x.title} ${local?'<span class="pill badge-arch">–ª–æ–∫–∞–ª—å–Ω–æ –≤ –∞—Ä—Ö–∏–≤–µ</span>':''}</td><td>${price}</td><td>${until}</td><td>${left}</td><td class="row"><button class="btn" data-act="edit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button><button class="btn" data-act="dup">–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å</button><button class="btn" data-act="delete">–£–¥–∞–ª–∏—Ç—å</button></td></tr>`;}).join('')||`<tr><td colspan="5" class="mut">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</td></tr>`;
      [...tbody.querySelectorAll('tr')].forEach(tr=>{const id=tr.getAttribute('data-id'); const bind=(act,fn)=>{const b=tr.querySelector(`[data-act="${act}"]`); if(b) b.onclick=()=>fn(id)}; bind('delete', deleteOffer); bind('edit',openEdit); bind('dup',duplicateOffer); });
    }catch(e){ log('offers: '+e); }
  }

  async function deleteOffer(id){
  try{
    const paths = await discoverAPI();
    const candidates = [];
    for(const p of Object.keys(paths||{})){
      if(/delete/.test(p) && /offer/.test(p)) candidates.push(p);
      if(/offers\/.+\{(id|offer_id)\}/.test(p) && (paths[p].delete || /delete/.test(JSON.stringify(paths[p]||{})))) candidates.push(p);
    }
    candidates.push(`/api/v1/merchant/offers/${id}`); // DELETE common
    candidates.push(`/api/v1/merchant/offers/${id}/delete`);
    candidates.push(`/api/v1/merchant/delete_offer/${id}`);
    candidates.push(`/api/v1/merchant/offers/delete/${id}`);
    for(const p of candidates){
      let url = p.includes('{') ? p.replace('{offer_id}', id).replace('{id}', id) : p;
      let r = await fetch(API()+url, { method:'DELETE', headers:{'X-Foody-Key':KEY()} });
      if(!r.ok){
        r = await fetch(API()+url, { method:'POST', headers:{'Content-Type':'application/json','X-Foody-Key':KEY()}, body: JSON.stringify({restaurant_id: RID(), offer_id:id, action:'delete'}) });
      }
      if(!r.ok){
        r = await fetch(API()+`${url}?restaurant_id=${RID()}&offer_id=${id}`, { method:'POST', headers:{'X-Foody-Key':KEY()} });
      }
      if(r.ok){ toast('–£–¥–∞–ª–µ–Ω–æ'); loadOffers(); return }
    }
    // Local fallback: hide row
    const set = localArchived(); set.add(id); saveLocalArchived(set); // reuse local set to hide
    toast('–£–¥–∞–ª–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ'); loadOffers();
  }catch(e){
    log('delete js: '+e); toast('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
  }
}
      const set=localArchived(); set.add(id); saveLocalArchived(set); toast('–ü–æ–º–µ—á–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ –∫–∞–∫ –∞—Ä—Ö–∏–≤'); loadOffers();
    }catch(e){ log('archive js: '+e); toast('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞') }
  }

  let EDIT_ID=null; function openEdit(id){ EDIT_ID=id; const x=OFFERS_CACHE.find(o=>o.id===id); if(!x){toast('–ù–µ –Ω–∞–π–¥–µ–Ω –æ—Ñ—Ñ–µ—Ä'); return}
    $('edit_title').value=x.title||''; $('edit_descr').value=x.description||''; $('edit_price').value=(x.price_cents?(x.price_cents/100).toFixed(2).replace('.',','):'');
    $('edit_original').value=(x.original_price_cents?(x.original_price_cents/100).toFixed(2).replace('.',','):'');
    const d=new Date(x.expires_at); $('edit_expires').value=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}T${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    $('editModal').style.display='flex'; }
  $('btnEditCancel').onclick=()=>{$('editModal').style.display='none'; EDIT_ID=null;};
  $('btnEditSave').onclick=async()=>{ if(!EDIT_ID) return; const x=OFFERS_CACHE.find(o=>o.id===EDIT_ID); if(!x) return;
    // client-side apply
    x.title=$('edit_title').value||x.title; x.description=$('edit_descr').value||x.description;
    const pc=Math.round(parseFloat(($('edit_price').value||'0').replace(',','.'))*100)||x.price_cents; const opc=Math.round(parseFloat(($('edit_original').value||'0').replace(',','.'))*100)||x.original_price_cents;
    x.price_cents=pc; x.original_price_cents=opc; try{x.expires_at=new Date($('edit_expires').value).toISOString()}catch(_){}
    toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ'); $('editModal').style.display='none'; renderFromCache(); };

  function renderFromCache(){ const arch=localArchived(); const tbody=$('tbody'); tbody.innerHTML=OFFERS_CACHE.map(x=>{
    const price=(x.original_price_cents?`<span class="price"><s>${rub(x.original_price_cents)} ‚ÇΩ</s> ‚Üí </span>`:'')+`<b>${rub(x.price_cents)} ‚ÇΩ</b>`; const until=new Date(x.expires_at).toLocaleString(); const left=`${x.qty_left}/${x.qty_total}`; const local=arch.has(x.id);
    return `<tr data-id="${x.id}"><td>${x.title} ${local?'<span class="pill badge-arch">–ª–æ–∫–∞–ª—å–Ω–æ –≤ –∞—Ä—Ö–∏–≤–µ</span>':''}</td><td>${price}</td><td>${until}</td><td>${left}</td><td class="row"><button class="btn" data-act="edit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button><button class="btn" data-act="dup">–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å</button><button class="btn" data-act="delete">–£–¥–∞–ª–∏—Ç—å</button></td></tr>`;}).join('')||`<tr><td colspan="5" class="mut">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</td></tr>`;
    [...tbody.querySelectorAll('tr')].forEach(tr=>{const id=tr.getAttribute('data-id'); const bind=(a,f)=>{const b=tr.querySelector(`[data-act="${a}"]`); if(b) b.onclick=()=>f(id)}; bind('delete', deleteOffer); bind('edit',openEdit); bind('dup',duplicateOffer); });
  }

  async function duplicateOffer(id){
    const x=OFFERS_CACHE.find(o=>o.id===id); if(!x){ toast('–ù–µ –Ω–∞–π–¥–µ–Ω –æ—Ñ—Ñ–µ—Ä'); return }
    const body={ restaurant_id:RID(), title:(x.title||'')+' (–∫–æ–ø–∏—è)', description:x.description||'', price_cents:x.price_cents||0, original_price_cents:x.original_price_cents||null, qty_total:x.qty_total||1, qty_left:x.qty_left||1, expires_at:x.expires_at };
    const r=await fetch(API()+'/api/v1/merchant/offers',{method:'POST',headers:{'Content-Type':'application/json','X-Foody-Key':KEY()}, body:JSON.stringify(body)});
    if(r.ok){ toast('–°–æ–∑–¥–∞–Ω –¥—É–±–ª–∏–∫–∞—Ç'); loadOffers(); } else { const t=await r.text().catch(()=> ''); log('dup: '+r.status+' '+t); toast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å') }
  }

  async function createOffer(){
    const body={ restaurant_id:RID(), title:($('title').value||'').trim(), description:($('descr').value||'').trim(), price_cents:numCents($('price')), original_price_cents:numCents($('original_price'))||null, qty_total:parseInt($('qty').value||'1',10), qty_left:parseInt($('qty').value||'1',10), expires_at:$('expires').value? new Date($('expires').value).toISOString(): null };
    if(!body.title||!body.price_cents||!body.expires_at){ toast('–ó–∞–ø–æ–ª–Ω–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ü–µ–Ω—É –∏ —Å—Ä–æ–∫'); return }
    const r=await fetch(API()+'/api/v1/merchant/offers',{method:'POST',headers:{'Content-Type':'application/json','X-Foody-Key':KEY()}, body:JSON.stringify(body)});
    if(r.ok){ toast('–°–æ–∑–¥–∞–Ω–æ'); loadOffers(); } else { const t=await r.text().catch(()=> ''); log('create_offer: '+r.status+' '+t); toast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å') }
  }

  async function exportCSV(){
    try{
      if(!Array.isArray(OFFERS_CACHE)||OFFERS_CACHE.length===0){ await loadOffers(); }
      const arch=localArchived(); const rows=[['id','title','price_cents','original_price_cents','qty_left','qty_total','expires_at','archived_local']];
      for(const x of (OFFERS_CACHE||[])){ rows.push([x.id,x.title||'',x.price_cents||'',x.original_price_cents||'',x.qty_left||'',x.qty_total||'',x.expires_at||'', arch.has(x.id)?'1':'']); }
      const csv=rows.map(r=>r.map(v=>{const s=String(v??''); return /[",;\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s;}).join(',')).join('\n');
      const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'})); a.download=`foody_export_${Date.now()}.csv`; a.click(); toast('CSV —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω –ª–æ–∫–∞–ª—å–Ω–æ');
    }catch(e){ log('export js: '+e); toast('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞') }
  }

  async function redeem(){
    try{ const code=($('redeemCode')?.value||'').trim(); if(!code){ toast('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥'); return }
      let r=await fetch(API()+'/api/v1/merchant/redeem',{method:'POST',headers:{'Content-Type':'application/json','X-Foody-Key':KEY()}, body:JSON.stringify({restaurant_id:RID(), code})});
      if(!r.ok){ const t=await r.text().catch(()=> ''); log('redeem: '+r.status+' '+t); toast('–û—à–∏–±–∫–∞ –ø–æ–≥–∞—à–µ–Ω–∏—è'); return }
      toast('–ü–æ–≥–∞—à–µ–Ω–æ'); $('redeemCode').value=''; loadKPI();
    }catch(e){ log('redeem js: '+e); toast('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞') }
  }

  async function loadKPI(){
    try{ const r=await fetch(API()+`/api/v1/merchant/kpi?restaurant_id=${RID()}`,{headers:{'X-Foody-Key':KEY()}});
      if(!r.ok){ $('kpiCard').style.display='none'; return } const k=await r.json(); $('kpiCard').style.display='block';
      $('kpiBox').innerHTML=`–ë—Ä–æ–Ω–µ–π: <b>${k.reserved}</b>, –í—ã–¥–∞—á: <b>${k.redeemed}</b>, –ö–æ–Ω–≤–µ—Ä—Å–∏—è: <b>${(k.redemption_rate*100).toFixed(1)}%</b><br/>–í—ã—Ä—É—á–∫–∞: <b>${(k.revenue_cents/100).toFixed(2).replace('.',',')} ‚ÇΩ</b> ¬∑ –≠–∫–æ–Ω–æ–º–∏—è –≥–æ—Å—Ç—è: <b>${(k.saved_cents/100).toFixed(2).replace('.',',')} ‚ÇΩ</b>`;
    }catch(e){ $('kpiCard').style.display='none'; }
  }
})();</script></body></html>
