<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Foody ‚Äî –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</title>
  <script src="/config.js"></script>
  <style>
    :root{
      --bg:#0b0c10; --card:#12141a; --mut:#8b90a2; --pri:#7bd88f; --err:#ff6b6b; --br:#22252f;
    }
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#0b0c10,#10131a 60%);color:#eef1f5;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1000px;margin:0 auto;padding:16px 16px 48px}
    h1{font-size:22px;margin:8px 0 14px} h3{margin:4px 0 10px}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:1fr 1fr} .g3{grid-template-columns:1fr 1fr 1fr}
    .card{background:var(--card);border:1px solid var(--br);border-radius:16px;padding:14px}
    label{display:block;margin:6px 0 6px 2px;color:#cbd1de;font-size:12px}
    input,textarea,select{width:100%;padding:12px 12px;border:1px solid var(--br);border-radius:12px;background:#0e1117;color:#eef1f5;outline:none}
    textarea{min-height:80px;resize:vertical}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{padding:10px 12px;border-radius:12px;border:1px solid var(--br);background:#131723;color:#eef1f5;cursor:pointer}
    .btn.primary{background:var(--pri);color:#08120b;border-color:#57c874}
    .btn.secondary{background:#191d2a}
    .btn.ghost{background:transparent;border-color:#2b3042;color:#b9bfd0}
    .mut{color:var(--mut)} .ok{color:var(--pri)} .err{color:var(--err)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #2a3040;background:#111522;color:#cdd3e2;font-size:12px}
    .price s{color:#9aa1b3}
    .toast{position:fixed;right:12px;bottom:12px;background:#090c12;border:1px solid #2b3042;color:#eef1f5;padding:10px 12px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
    .tbl{width:100%;border-collapse:collapse} .tbl th,.tbl td{border-bottom:1px solid #232838;padding:10px 8px}
    .tbl th{color:#9aa1b3;font-weight:600;text-transform:uppercase;font-size:12px;letter-spacing:.3px}
    .split{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
    @media(max-width:860px){.g2,.g3,.split{grid-template-columns:1fr}}
    .kbd{font:12px/1.8 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;border:1px solid #2b3042;background:#0d111a;color:#cdd3e2;padding:0 6px;border-radius:6px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>üçΩ Foody ‚Äî –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>

  <div class="split">
    <div class="grid">
      <div class="card">
        <h3>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</h3>
        <div class="grid g2">
          <div>
            <label>–ê–¥—Ä–µ—Å API</label>
            <input id="api" placeholder="https://backend-....up.railway.app">
            <div class="mut" style="margin-top:6px">–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ. –ï—Å–ª–∏ –∫–æ–Ω—Ñ–∏–≥ –Ω–µ –ø–æ–¥—Ö–≤–∞—Ç–∏–ª—Å—è ‚Äî —É–∫–∞–∂–∏ –≤—Ä—É—á–Ω—É—é.</div>
          </div>
          <div class="row" style="align-items:end">
            <button class="btn" id="btnSaveApi">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å API</button>
            <button class="btn" id="btnProbe">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
            <button class="btn ghost" id="btnClear">–°–±—Ä–æ—Å–∏—Ç—å –õ–ö</button>
          </div>
        </div>
        <pre id="log" class="mut" style="max-height:140px;overflow:auto;background:#0c1018;border:1px dashed #2b3042;padding:8px;border-radius:12px;margin-top:8px"></pre>
      </div>

      <div class="card" id="cardRegister">
        <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</h3>
        <div class="grid g2">
          <div>
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input id="name" placeholder="–ü–µ–∫–∞—Ä–Ω—è ‚Ññ1">
          </div>
          <div>
            <label>–¢–µ–ª–µ—Ñ–æ–Ω (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
            <input id="phone" placeholder="+7...">
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn primary" id="btnRegister">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <span class="mut">RID –∏ –∫–ª—é—á —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ</span>
        </div>
      </div>

      <div class="card" id="cardOffer" style="display:none">
        <h3>–ù–æ–≤—ã–π –æ—Ñ—Ñ–µ—Ä</h3>
        <div class="grid g2">
          <div><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="title" placeholder="–°—É–ø-–ø—é—Ä–µ –¥–Ω—è"></div>
          <div><label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label><input id="qty" value="5"></div>
        </div>
        <label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="descr" placeholder="–ö–æ—Ä–æ—Ç–∫–æ..."></textarea>
        <div class="grid g3">
          <div><label>–¶–µ–Ω–∞, ‚ÇΩ</label><input id="price" placeholder="199,00"></div>
          <div><label>–û–±—ã—á–Ω–∞—è —Ü–µ–Ω–∞, ‚ÇΩ</label><input id="original_price" placeholder="349,00"></div>
          <div><label>–î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –¥–æ</label><input id="expires" type="datetime-local"></div>
        </div>
        <div class="row" style="margin-top:6px">
          <span class="pill">–ë—ã—Å—Ç—Ä—ã–µ</span>
          <button class="btn" id="btnPreset30">‚àí30%</button>
          <button class="btn" id="btnPreset50">‚àí50%</button>
          <button class="btn" id="btnPreset70">‚àí70%</button>
          <span class="pill">–í—Ä–µ–º—è</span>
          <button class="btn" id="btnPlus1h">+1 —á–∞—Å</button>
          <button class="btn" id="btnPlus2h">+2 —á–∞—Å–∞</button>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="btnCreateOffer">–°–æ–∑–¥–∞—Ç—å –æ—Ñ—Ñ–µ—Ä</button>
        </div>
      </div>

      <div class="card">
  <h3>–ö–∞—Å—Å–∞: –ø–æ–≥–∞—à–µ–Ω–∏–µ –±—Ä–æ–Ω–∏</h3>
  <div class="row"><div><input id="redeemCode" placeholder="–í–≤–µ—Å—Ç–∏ –∫–æ–¥"></div>
  <div><button class="btn primary" id="btnRedeem">–ü–æ–≥–∞—Å–∏—Ç—å</button></div></div>
  <div class="mut">–°–∫–∞–Ω–µ—Ä QR –º–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∫–∞–∫ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É. –ï—Å–ª–∏ —Å–µ—Ä–≤–∏—Å –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–µ–∑–µ—Ä–≤—ã ‚Äî –±–ª–æ–∫ —Å–∫—Ä–æ–µ—Ç—Å—è.</div>
</div>

<div class="card" id="kpiCard" style="display:none">
  <h3>KPI</h3>
  <div id="kpiBox" class="mut">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<div class="card" id="cardGrid" style="display:none">
        <h3>–ú–æ–∏ –æ—Ñ—Ñ–µ—Ä—ã</h3>
        <table class="tbl" id="offersTbl">
          <thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–¶–µ–Ω–∞</th><th>–î–æ</th><th>–û—Å—Ç–∞—Ç–æ–∫</th><th></th></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="btnExport">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card" id="cardProfile" style="display:none">
        <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>
        <label>RID</label><input id="rid" readonly>
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="prof_title">
        <label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="prof_phone">
        <div class="row" style="margin-top:8px">
          <button class="btn primary" id="btnSaveProfile">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
        </div>
      </div>

      <div class="card">
        <h3>–ü–æ–¥—Å–∫–∞–∑–∫–∏</h3>
        <div class="mut">
          <div>‚Ä¢ <span class="kbd">Ctrl/Cmd + R</span> ‚Äî —Å–±—Ä–æ—Å–∏—Ç—å –∫—ç—à –õ–ö</div>
          <div>‚Ä¢ –°–∫–∏–¥–∫–∏ –ø–æ –∫–Ω–æ–ø–∫–∞–º —Å—á–∏—Ç–∞—é—Ç –æ—Ç ¬´–û–±—ã—á–Ω–æ–π —Ü–µ–Ω—ã¬ª</div>
          <div>‚Ä¢ –ï—Å–ª–∏ API –Ω–µ –æ—Ç–∫–ª–∏–∫–∞–µ—Ç—Å—è ‚Äî –Ω–∞–∂–º–∏ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å¬ª –∏ –ø—Ä–∏—à–ª–∏ –º–Ω–µ –ª–æ–≥ –Ω–∏–∂–µ</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // --- Utils
  async function discoverAPI(){
    try{
      const r = await fetch(API()+'/openapi.json',{cache:'no-store'});
      if(!r.ok) return {};
      const j = await r.json();
      return j.paths || {};
    }catch(_){ return {} }
  }
  const $ = id => document.getElementById(id);
  const toast = t => { const d=document.createElement('div'); d.className='toast'; d.textContent=t; document.body.appendChild(d); setTimeout(()=>d.remove(),2500); };
  const pad = n => String(n).padStart(2,'0');
  const asISO = v => v ? new Date(v).toISOString() : null;
  const fmtLocalInput = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  const rub = n => (n/100).toFixed(2).replace('.',',');
  const numCents = inp => Math.round(parseFloat((inp.value||'0').replace(',','.'))*100)||0;
  const log = t => { const el=$('log'); el.textContent = (t||'')+"\n"+el.textContent; };

  // --- API resolve
  function resolveApi(){
    const c = (window.foodyApi||'').trim();
    const ls = (localStorage.getItem('foody_api')||'').trim();
    const fb = location.origin.replace(/\/web$/, '');
    return c || ls || fb;
  }
  function API(){ return resolveApi() }
  function setApi(v){ localStorage.setItem('foody_api', (v||'').trim()); $('api').value=(v||'').trim(); }

  // --- State
  let OFFERS_CACHE = [];
  const RID = () => { try{ return (JSON.parse(localStorage.getItem('foody_restaurant')||'{}').id)||'' }catch(_){ return '' } };
  const KEY = () => localStorage.getItem('foody_key')||'';

  // --- UI wiring
  document.addEventListener('DOMContentLoaded', ()=>{
    $('api').value = resolveApi();
    $('btnSaveApi').onclick = ()=>{ setApi($('api').value); toast('API —Å–æ—Ö—Ä–∞–Ω—ë–Ω') };
    $('btnProbe').onclick = async ()=>{
      try{ const r = await fetch(API()+'/health',{cache:'no-store'}); log('GET /health ‚Üí '+r.status+' '+(r.ok?'OK':'ERR')); }
      catch(e){ log('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: '+e) }
    };
    $('btnClear').onclick = ()=>{ localStorage.removeItem('foody_restaurant'); localStorage.removeItem('foody_key'); location.reload() };

    $('btnRegister').onclick = registerRestaurant; document.getElementById('btnRedeem').onclick = redeem;
    $('btnSaveProfile').onclick = saveProfile;
    $('btnCreateOffer').onclick = createOffer;
    $('btnExport').onclick = exportCSV;

    $('btnPreset30').onclick = ()=>{ const p=numCents($('original_price')); if(p>0) $('price').value=(p*0.7/100).toFixed(2).replace('.',',') };
    $('btnPreset50').onclick = ()=>{ const p=numCents($('original_price')); if(p>0) $('price').value=(p*0.5/100).toFixed(2).replace('.',',') };
    $('btnPreset70').onclick = ()=>{ const p=numCents($('original_price')); if(p>0) $('price').value=(p*0.3/100).toFixed(2).replace('.',',') };

    $('btnPlus1h').onclick = ()=>{ const d=$('expires').value?new Date($('expires').value):new Date(); d.setHours(d.getHours()+1); $('expires').value=fmtLocalInput(d) };
    $('btnPlus2h').onclick = ()=>{ const d=$('expires').value?new Date($('expires').value):new Date(); d.setHours(d.getHours()+2); $('expires').value=fmtLocalInput(d) };

    // default expires +2h
    const d=new Date(); d.setHours(d.getHours()+2); $('expires').value = fmtLocalInput(d);

    if(RID()){ enterLK(); }
    document.addEventListener('keydown', (e)=>{
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='r'){ e.preventDefault(); localStorage.removeItem('foody_restaurant'); localStorage.removeItem('foody_key'); location.reload(); }
    });
  });

  function enterLK(){
    $('cardRegister').style.display='none';
    $('cardOffer').style.display='block';
    $('cardGrid').style.display='block';
    $('cardProfile').style.display='block';
    $('rid').value = RID();
    loadProfile(); loadOffers(); loadKPI();
  }

  // --- Actions
  async function archiveOffer(id){
  try{
    const paths = await discoverAPI();
    const candidates = [];
    for(const p of Object.keys(paths||{})){
      if(/archive/.test(p) && /offer/.test(p)) candidates.push(p);
    }
    candidates.push(`/api/v1/merchant/offers/${id}/archive`);
    candidates.push(`/api/v1/merchant/offers/archive/${id}`);
    candidates.push(`/api/v1/merchant/archive/${id}`);
    candidates.push(`/api/v1/merchant/archive_offer/${id}`);
    candidates.push(`/api/v1/merchant/archive`);
    for(const p of candidates){
      let url = p.includes('{') ? p.replace('{offer_id}', id).replace('{id}', id) : p;
      if(!url.includes(id) && /archive$/.test(url)) url = url + `/${id}`;
      let r = await fetch(API()+url, {
        method:'POST',
        headers:{'Content-Type':'application/json','X-Foody-Key':KEY()},
        body: JSON.stringify({restaurant_id: RID(), offer_id: id})
      });
      if(!r.ok){
        r = await fetch(API()+url, {
          method:'POST',
          headers:{'Content-Type':'text/plain','X-Foody-Key':KEY()},
          body: JSON.stringify({restaurant_id: RID(), offer_id: id})
        });
      }
      if(!r.ok && url.endsWith('/archive')){
        r = await fetch(API()+`${url}?restaurant_id=${RID()}&offer_id=${id}`, {
          method:'POST',
          headers:{'X-Foody-Key':KEY()}
        });
      }
      if(!r.ok){
        r = await fetch(API()+`${url}?restaurant_id=${RID()}&offer_id=${id}`, {
          method:'GET',
          headers:{'X-Foody-Key':KEY()}
        });
      }
      if(r.ok){ toast('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –∞—Ä—Ö–∏–≤'); loadOffers(); return }
    }
    toast('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –∞—Ä—Ö–∏–≤');
  }catch(e){
    log('archive js: '+e); toast('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
  }
}

  async function exportCSV(){
    try{
      // –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —ç–∫—Å–ø–æ—Ä—Ç –∏–∑ –∫–µ—à–∞ OFFERS_CACHE
      if(!Array.isArray(OFFERS_CACHE) || OFFERS_CACHE.length===0){
        await loadOffers();
      }
      const rows = [['id','title','price_cents','original_price_cents','qty_left','qty_total','expires_at','archived_at']];
      for(const x of (OFFERS_CACHE||[])){
        rows.push([x.id, x.title||'', x.price_cents||'', x.original_price_cents||'', x.qty_left||'', x.qty_total||'', x.expires_at||'', x.archived_at||'']);
      }
      const csv = rows.map(r=>r.map(v=>{
        const s = String(v??'');
        return /[",;\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(',')).join('\n');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv;charset=utf-8;'}));
      a.download = `foody_export_${Date.now()}.csv`;
      a.click();
      toast('CSV —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω –ª–æ–∫–∞–ª—å–Ω–æ (–±–µ–∑ –±—ç–∫–∞)');
    }catch(e){
      log('export js: '+e); toast('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞');
    }
  }

  async function registerRestaurant(){
    const name=($('name').value||'').trim();
    const phone=($('phone').value||'').trim();
    if(!name){ toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'); return }
    for(let i=0;i<2;i++){ try{ await fetch(API()+'/health',{cache:'no-store'}) }catch(_){} }
    try{
      let r = await fetch(API()+'/api/v1/merchant/register_public', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({title:name, phone})
      });
      if(!r.ok){
        const t=await r.text().catch(()=>'');
        log('register_public (json): '+r.status+' '+t);
        if(r.status===415 || r.status===422 || r.status===400){
          r = await fetch(API()+'/api/v1/merchant/register_public', {
            method:'POST',
            headers:{'Content-Type':'text/plain'},
            body: JSON.stringify({title:name, phone})
          });
        }
      }
      if(!r.ok){ const t=await r.text().catch(()=> ''); log('register_public: '+r.status+' '+t); toast('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏'); return }
      const data = await r.json();
      localStorage.setItem('foody_restaurant', JSON.stringify({id:data.restaurant_id, title:name, phone}));
      localStorage.setItem('foody_key', data.api_key);
      enterLK(); toast('–ì–æ—Ç–æ–≤–æ!');
    }catch(e){ log('JS: '+e); toast('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞') }
  }

  async function redeem(){
    try{
      const code = (document.getElementById('redeemCode')?.value||'').trim();
      if(!code){ toast('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥'); return }
      let r = await fetch(API() + '/api/v1/merchant/redeem', {
        method:'POST',
        headers:{'Content-Type':'application/json','X-Foody-Key':KEY()},
        body: JSON.stringify({restaurant_id: RID(), code})
      });
      if(!r.ok){
        const t=await r.text().catch(()=>'');
        log('redeem: '+r.status+' '+t);
        if(r.status===404){ document.getElementById('redeemCode').value=''; return }
        toast('–û—à–∏–±–∫–∞ –ø–æ–≥–∞—à–µ–Ω–∏—è'); return
      }
      toast('–ü–æ–≥–∞—à–µ–Ω–æ'); document.getElementById('redeemCode').value=''; loadKPI();
    }catch(e){ log('redeem js: '+e); toast('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞') }
  }

  async function loadKPI(){
    try{
      const r = await fetch(API() + `/api/v1/merchant/kpi?restaurant_id=${RID()}`, {headers:{'X-Foody-Key':KEY()}});
      if(!r.ok){ document.getElementById('kpiCard').style.display='none'; return }
      const k = await r.json();
      const rub = n=> (n/100).toFixed(2).replace('.',',');
      document.getElementById('kpiCard').style.display='block';
      document.getElementById('kpiBox').innerHTML = `
        –ë—Ä–æ–Ω–µ–π: <b>${k.reserved}</b>, –í—ã–¥–∞—á: <b>${k.redeemed}</b>, –ö–æ–Ω–≤–µ—Ä—Å–∏—è: <b>${(k.redemption_rate*100).toFixed(1)}%</b><br/>
        –í—ã—Ä—É—á–∫–∞: <b>${rub(k.revenue_cents)} ‚ÇΩ</b> ¬∑ –≠–∫–æ–Ω–æ–º–∏—è –≥–æ—Å—Ç—è: <b>${rub(k.saved_cents)} ‚ÇΩ</b>
      `;
    }catch(e){ document.getElementById('kpiCard').style.display='none'; }
  }

  async function loadProfile(){
    try{
      const r = await fetch(API()+`/api/v1/merchant/profile?restaurant_id=${RID()}`, {headers:{'X-Foody-Key':KEY()}});
      if(!r.ok) return;
      const p = await r.json();
      $('prof_title').value = p.title||'';
      $('prof_phone').value = p.phone||'';
    }catch(_){}
  }

  async function saveProfile(){
    const body={restaurant_id: RID(), title: $('prof_title').value||'', phone: $('prof_phone').value||''};
    const r = await fetch(API()+'/api/v1/merchant/profile', {method:'POST', headers:{'Content-Type':'application/json','X-Foody-Key':KEY()}, body: JSON.stringify(body)});
    if(r.ok){ toast('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω') } else { const t=await r.text().catch(()=> ''); log('profile: '+r.status+' '+t); toast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è') }
  }

  async function loadOffers(){
    try{
      const r = await fetch(API()+`/api/v1/merchant/offers?restaurant_id=${RID()}&status=active`, {headers:{'X-Foody-Key':KEY()}});
      const arr = r.ok ? await r.json() : []; OFFERS_CACHE = arr;
      const tbody = $('tbody');
      tbody.innerHTML = arr.map(x=>{
        const price = (x.original_price_cents? `<span class="price"><s>${rub(x.original_price_cents)} ‚ÇΩ</s> ‚Üí </span>`:'' ) + `<b>${rub(x.price_cents)} ‚ÇΩ</b>`;
        const until = new Date(x.expires_at).toLocaleString();
        const left = `${x.qty_left}/${x.qty_total}`;
        return `<tr>
          <td>${x.title}</td>
          <td>${price}</td>
          <td>${until}</td>
          <td>${left}</td>
          <td><button class="btn ghost" data-id="${x.id}" data-act="archive" class="archive-btn">–ê—Ä—Ö–∏–≤</button></td>
        </tr>`;
      }).join('') || `<tr><td colspan="5" class="mut">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</td></tr>`;
      // bind archive
      [...tbody.querySelectorAll('button[data-act="archive"]')].forEach(b=>{
        b.onclick = async ()=>{
          const id = b.getAttribute('data-id');
          await archiveOffer(id);
        };
      });
    }catch(e){ log('offers: '+e); }
  }

  async function createOffer(){
    const body = {
      restaurant_id: RID(),
      title: ($('title').value||'').trim(),
      description: ($('descr').value||'').trim(),
      price_cents: numCents($('price')),
      original_price_cents: numCents($('original_price')) || null,
      qty_total: parseInt($('qty').value||'1',10),
      qty_left: parseInt($('qty').value||'1',10),
      expires_at: $('expires').value ? new Date($('expires').value).toISOString() : null
    };
    if(!body.title || !body.price_cents || !body.expires_at){ toast('–ó–∞–ø–æ–ª–Ω–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ü–µ–Ω—É –∏ —Å—Ä–æ–∫'); return }
    const r = await fetch(API()+'/api/v1/merchant/offers', {method:'POST', headers:{'Content-Type':'application/json','X-Foody-Key':KEY()}, body: JSON.stringify(body)});
    if(r.ok){ toast('–°–æ–∑–¥–∞–Ω–æ'); loadOffers(); } else { const t=await r.text().catch(()=> ''); log('create_offer: '+r.status+' '+t); toast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å') }
  }

  async function exportCSV(){
    try{
      const r = await fetch(API()+`/api/v1/merchant/export.csv?restaurant_id=${RID()}`, {headers:{'X-Foody-Key':KEY()}});
      if(!r.ok){ toast('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞'); return }
      const txt = await r.text();
      const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([txt], {type:'text/csv;charset=utf-8;'})); a.download = `foody_export_${Date.now()}.csv`; a.click();
    }catch(e){ log('export: '+e); toast('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞') }
  }
})();
</script>
</body>
</html>
