<!doctype html><html lang="ru"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Foody ‚Äî –õ–ö (—Ä–µ–≥-—Ö–æ—Ç—Ñ–∏–∫—Å)</title>
<script src="/config.js"></script>
<style>
  :root{--bg:#0b0c10;--card:#12141a;--br:#22252f;--pri:#7bd88f;--mut:#8b90a2}
  *{box-sizing:border-box} body{margin:0;background:#0b0c10;color:#eef1f5;font-family:Inter,system-ui,Segoe UI,Roboto}
  .wrap{max-width:900px;margin:0 auto;padding:16px}
  .card{background:#12141a;border:1px solid var(--br);border-radius:14px;padding:12px}
  input{width:100%;padding:10px;border:1px solid var(--br);border-radius:12px;background:#0e1117;color:#eef1f5;outline:none}
  .btn{padding:10px 12px;border-radius:12px;border:1px solid var(--br);background:#131723;color:#eef1f5;cursor:pointer}
  .btn.primary{background:var(--pri);color:#08120b;border-color:#57c874}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .mut{color:var(--mut)} .toast{position:fixed;right:12px;bottom:12px;background:#090c12;border:1px solid #2b3042;color:#eef1f5;padding:10px 12px;border-radius:12px}
  pre{max-height:160px;overflow:auto;background:#0c1018;border:1px dashed #2b3042;padding:8px;border-radius:12px}
</style>
</head><body>
<div class="wrap">
  <h1>üçΩ Foody ‚Äî –õ–ö (—Ö–æ—Ç—Ñ–∏–∫—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)</h1>
  <div class="card">
    <div class="row">
      <div style="flex:1">
        <div class="mut">–¢–µ–∫—É—â–∏–π API</div>
        <input id="api" placeholder="https://backend-....up.railway.app">
        <div class="mut" id="apiHint"></div>
      </div>
      <div class="row" style="align-items:end">
        <button class="btn" id="btnSaveApi">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å API</button>
        <button class="btn" id="btnCheck">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
      </div>
    </div>
    <pre id="log"></pre>
  </div>

  <div class="card" style="margin-top:10px">
    <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
    <div class="row">
      <div style="flex:1"><input id="name" placeholder="–ü–µ–∫–∞—Ä–Ω—è ‚Ññ1"></div>
      <div style="flex:1"><input id="phone" placeholder="+7... (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn primary" id="btnRegister">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <span class="mut">RID –∏ –∫–ª—é—á —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ</span>
    </div>
  </div>
</div>
<script>
(function(){
  const $=id=>document.getElementById(id);
  const toast=t=>{const d=document.createElement('div'); d.className='toast'; d.textContent=t; document.body.appendChild(d); setTimeout(()=>d.remove(),2600)};
  function resolveApi(){const c=(window.foodyApi||'').trim(); const ls=(localStorage.getItem('foody_api')||'').trim(); const fb=location.origin.replace(/\/web$/,''); return c||ls||fb;}
  function API(){return resolveApi()} function setApi(v){localStorage.setItem('foody_api',(v||'').trim()); $('api').value=(v||'').trim(); $('apiHint').textContent='–ê–¥—Ä–µ—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω –ª–æ–∫–∞–ª—å–Ω–æ';}
  function log(t){$('log').textContent=(t||'')+"\n"+$('log').textContent}

  document.addEventListener('DOMContentLoaded', ()=>{
    $('api').value=resolveApi(); $('apiHint').textContent='–ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω window.foodyApi ‚Äî –æ–Ω –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ localStorage';
    $('btnSaveApi').onclick=()=>{ setApi($('api').value) };
    $('btnCheck').onclick=async()=>{ try{ const r=await fetch(API()+'/health',{cache:'no-store',mode:'cors'}); log('GET /health ‚Üí '+r.status+' '+(r.ok?'OK':'ERR')); }catch(e){ log('check: '+e) } };
    $('btnRegister').onclick=register;
  });

  async function tryRegister(url, body){
    const optsBase = { method:'POST', mode:'cors', cache:'no-store', keepalive:false, redirect:'follow' };
    try{
      let r = await fetch(API()+url, { ...optsBase, headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      if(r.type==='opaqueredirect' || r.status===0){ log('opaqueredirect on '+url+' (JSON)'); }
      if(r.ok) return r;
      log('POST '+url+' (JSON) ‚Üí '+r.status);
      const txt = await r.text().catch(()=>'');
      if(txt) log('Body: '+txt.slice(0,400));
      r = await fetch(API()+url, { ...optsBase, headers:{'Content-Type':'text/plain'}, body: JSON.stringify(body) });
      if(r.ok) return r;
      log('POST '+url+' (text/plain) ‚Üí '+r.status);
      return r;
    }catch(e){ log('fetch error '+url+': '+e); return null }
  }

  async function register(){
    const title = ($('name').value||'').trim(); const phone = ($('phone').value||'').trim();
    if(!title){ toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'); return }
    const body = { title, phone };
    const urls = ['/api/v1/merchant/register_public', '/api/v1/merchant/register_public/', '/api/v1/merchant/register'];
    try{ const h=await fetch(API()+'/health',{cache:'no-store'}); log('GET /health ‚Üí '+h.status) }catch(e){ log('health err: '+e) }
    let last=null;
    for(const u of urls){
      const r = await tryRegister(u, body);
      if(r && r.ok){
        const data = await r.json().catch(()=>null);
        if(!data){ toast('–û—Ç–≤–µ—Ç –±—ç–∫–∞ –Ω–µ JSON'); return }
        localStorage.setItem('foody_restaurant', JSON.stringify({id:data.restaurant_id, title, phone}));
        localStorage.setItem('foody_key', data.api_key||'');
        toast('–ì–æ—Ç–æ–≤–æ! –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ'); log('RID='+data.restaurant_id+' KEY='+String(data.api_key||'***'));
        return;
      }
      last = r;
    }
    if(last){ log('–ò—Ç–æ–≥: '+(last.status||'?')+' '+(last.statusText||'')) }
    toast('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å ‚Äî —Å–º. –ª–æ–≥ –≤—ã—à–µ');
  }
})();
</script>
</body></html>
