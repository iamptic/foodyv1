<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Foody ‚Äî –°–∫–∏–¥–∫–∏ —Ä—è–¥–æ–º</title>
  <script src="/config.js"></script>
  <style>
    :root{ --bg:#0b0c10; --card:#12141a; --mut:#8b90a2; --pri:#7bd88f; --br:#22252f; }
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#0b0c10,#10131a 60%);color:#eef1f5;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:980px;margin:0 auto;padding:16px 16px 48px}
    h1{font-size:22px;margin:8px 0 14px}
    .grid{display:grid;gap:12px;grid-template-columns:1fr 1fr} @media(max-width:780px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--br);border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:8px}
    .mut{color:var(--mut)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{padding:10px 12px;border-radius:12px;border:1px solid var(--br);background:#131723;color:#eef1f5;cursor:pointer}
    .btn.primary{background:var(--pri);color:#08120b;border-color:#57c874}
    .small{font-size:12px;color:#a8aebe}
    .price s{color:#9aa1b3}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #2a3040;background:#111522;color:#cdd3e2;font-size:12px}
    .timer{font-variant-numeric:tabular-nums}
  </style>
</head>
<body>
<div class="wrap">
  <h1>üî• Foody ‚Äî –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Ä—è–¥–æ–º</h1>
  <div class="row" style="margin-bottom:10px">
    <span class="mut small">API:</span>
    <input id="api" style="flex:1;max-width:420px;padding:8px;border-radius:10px;border:1px solid var(--br);background:#0e1117;color:#eef1f5;outline:none" placeholder="https://backend-....up.railway.app">
    <button class="btn" id="btnSaveApi">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button class="btn" id="btnReload">–û–±–Ω–æ–≤–∏—Ç—å</button>
  </div>
  <div id="list" class="grid"></div>
  <div id="empty" class="mut" style="display:none;margin-top:8px">–ü–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ—Ñ—Ñ–µ—Ä–æ–≤</div>
</div>
<script>
(function(){
  const $=id=>document.getElementById(id);
  function resolveApi(){ const c=(window.foodyApi||'').trim(); const ls=(localStorage.getItem('foody_api')||'').trim(); const fb=location.origin.replace(/\/web$/, ''); return c||ls||fb; }
  function API(){ return resolveApi() }
  function setApi(v){ localStorage.setItem('foody_api',(v||'').trim()); $('api').value=(v||'').trim(); }

  const r2 = n => (n/100).toFixed(2).replace('.',',');
  const minsLeft = iso => Math.max(0, Math.floor((new Date(iso).getTime()-Date.now())/60000));
  function tierPrice(o){
    if(!o.original_price_cents || o.original_price_cents<=0) return {tier:'', eff:o.price_cents||0};
    const m = minsLeft(o.expires_at);
    let disc = 0, label = '';
    if(m<=30){ disc=0.70; label='-70%'; }
    else if(m<=60){ disc=0.50; label='-50%'; }
    else if(m<=120){ disc=0.30; label='-30%'; }
    else { return {tier:'', eff:o.price_cents||o.original_price_cents}; }
    return {tier:label, eff: Math.round(o.original_price_cents*(1-disc))};
  }

  async function load(){
    $('api').value = resolveApi();
    try{
      const r = await fetch(API()+'/api/v1/offers',{cache:'no-store'});
      const arr = r.ok? await r.json(): [];
      const box = $('list'); box.innerHTML='';
      if(!arr.length){ $('empty').style.display='block'; return } else { $('empty').style.display='none' }
      for(const x of arr){
        const {tier, eff} = tierPrice(x);
        const m = minsLeft(x.expires_at);
        const el = document.createElement('div'); el.className='card';
        el.innerHTML = `
          <div class="row"><div class="pill">${m} –º–∏–Ω</div>${tier? `<div class="pill">${tier}</div>`:''}</div>
          <div style="font-size:18px;font-weight:600">${x.title}</div>
          <div class="small">${x.description||''}</div>
          <div class="row price">
            ${x.original_price_cents? `<s>${r2(x.original_price_cents)} ‚ÇΩ</s> ‚Üí `:''}
            <b>${r2(eff||x.price_cents)} ‚ÇΩ</b>
          </div>
          <div class="row">
            <button class="btn primary" data-id="${x.id}" data-act="reserve">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
            <div class="small">–¥–æ ${new Date(x.expires_at).toLocaleString()}</div>
          </div>
        `;
        box.appendChild(el);
      }
      // Bind reserve
      [...document.querySelectorAll('button[data-act="reserve"]')].forEach(b=>{
        b.onclick = async ()=>{
          const id = b.getAttribute('data-id');
          try{
            let r = await fetch(API()+'/api/v1/buyer/reserve',{method:'POST',headers:{'Content-Type':'application/json'}, body: JSON.stringify({offer_id:id})});
            if(!r.ok){
              const t=await r.text().catch(()=>'');
              if(r.status===404){ alert('–†–µ–∑–µ—Ä–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ —ç—Ç–æ–º —Å–µ—Ä–≤–µ—Ä–µ'); return }
              r = await fetch(API()+'/api/v1/buyer/reserve',{method:'POST',headers:{'Content-Type':'text/plain'}, body: JSON.stringify({offer_id:id})});
            }
            if(!r.ok){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å'); return }
            const data = await r.json();
            const html = `<div style="text-align:center;font-family:system-ui,Segoe UI,Roboto">
              <p>–ë—Ä–æ–Ω—å —Å–æ–∑–¥–∞–Ω–∞! –ü–æ–∫–∞–∂–∏—Ç–µ —ç—Ç–æ—Ç QR –Ω–∞ –∫–∞—Å—Å–µ.</p>
              <img src="${API() + '/api/v1/qr/' + encodeURIComponent(data.code) + '.png'}" style="width:220px;height:220px"/><br/>
              <div style="font-size:12px;color:#666">–ö–æ–¥: ${data.code}</div>
              <div style="font-size:12px;color:#666">–î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –¥–æ: ${new Date(data.expires_at).toLocaleString()}</div>
            </div>`;
            const w = window.open('', 'reserve', 'width=320,height=420'); w.document.write(html);
          }catch(e){ alert('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞') }
        }
      });
    }catch(e){ $('empty').style.display='block'; }
  }

  setInterval(load, 30000);
  document.addEventListener('DOMContentLoaded', ()=>{
    $('btnSaveApi').onclick = ()=>{ setApi($('api').value); load(); };
    $('btnReload').onclick = ()=> load();
    load();
  });
})();
</script>
</body>
</html>